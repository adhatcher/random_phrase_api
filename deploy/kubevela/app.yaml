apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: backend
  namespace: phrases
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  components:
    - name: backend
      type: webservice
      properties:
        labels:
          app: backend
          project: phrases
        image: ghcr.io/adhatcher/random_phrase_api:54e9ff1ef74947554891b47be1f453075d86e04d
        imagePullPolicy: IfNotPresent
        port: 7070
        readinessProbe:
          httpGet:
            path: /healthz
            port: 7070
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /healthz
            port: 7070
          initialDelaySeconds: 15
          periodSeconds: 20
          timeoutSeconds: 2
          failureThreshold: 3
        env:
          - name: ENVIRONMENT
            value: production
          - name: FLASK_HOST
            value: "0.0.0.0"
          - name: FLASK_PORT
            value: "7070"
          - name: API_HOST
            value: "backend"
          - name: API_PORT
            value: "7070"
      traits:
        - type: resource
          properties:
            limits:
              memory: "128Mi"
            requests:
              cpu: "8m"
              memory: "64Mi"
        - type: expose
          properties:
            type: ClusterIP
            matchLabels:
              app: backend
            ports:
              - name: http
                port: 7070
                protocol: TCP
        - type: httproute
          properties:
            routeName: backend
            hostname: backend.zeus
            path: /backend
            gateway:
              name: zeus-gw
              namespace: envoy-gateway-system
              sectionName: https
            service:
              name: backend
              port: 7070
    - name: backend-hpa
      type: k8s-objects
      properties:
        objects:
          - apiVersion: autoscaling/v2
            kind: HorizontalPodAutoscaler
            metadata:
              name: backend-hpa
              namespace: phrases
            spec:
              scaleTargetRef:
                apiVersion: apps/v1
                kind: Deployment
                name: backend
              minReplicas: 1
              maxReplicas: 4
              metrics:
                - type: Resource
                  resource:
                    name: cpu
                    target:
                      type: AverageValue
                      averageValue: 10m
                - type: Resource
                  resource:
                    name: memory
                    target:
                      type: AverageValue
                      averageValue: 100Mi
